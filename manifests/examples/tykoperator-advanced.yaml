apiVersion: vourteen14.labs/v1
kind: TykRoute
metadata:
  name: products-api
  namespace: default
  labels:
    app: products-api
    env: production
spec:
  target:
    configMapName: dynamic-api-routes
    tykDeployment: tyk-gateway

  apiDefinition:
    name: "Products API"
    api_id: "products-api-v1"
    active: true
    tags:
      - "ecommerce"
      - "public-api"
      - "v1"

    proxy:
      listen_path: "/api/v1/products/"
      target_url: "http://product-service.default.svc.cluster.local:3000"
      strip_listen_path: true
      preserve_host_header: false
      enable_load_balancing: true
      target_list:
        - "http://product-service-1.default.svc.cluster.local:3000"
        - "http://product-service-2.default.svc.cluster.local:3000"
        - "http://product-service-3.default.svc.cluster.local:3000"

    use_keyless: false
    enable_jwt: true
    jwt_signing_method: "rsa"
    jwt_source: "Authorization"
    jwt_identity_base_field: "sub"
    jwt_policy_field_name: "pol"
    jwt_default_policies:
      - "default-policy"

    global_rate_limit:
      rate: 100
      per: 60

    cache_options:
      enable_cache: true
      cache_timeout: 300
      cache_all_safe_requests: true
      cache_response_codes:
        - 200
        - 201
        - 404
      enable_upstream_cache_control: true

    CORS:
      enable: true
      allowed_origins:
        - "https://example.com"
        - "https://app.example.com"
        - "https://*.example.com"
      allowed_methods:
        - "GET"
        - "POST"
        - "PUT"
        - "PATCH"
        - "DELETE"
        - "OPTIONS"
      allowed_headers:
        - "Authorization"
        - "Content-Type"
        - "X-API-Key"
        - "X-Request-ID"
      exposed_headers:
        - "X-RateLimit-Limit"
        - "X-RateLimit-Remaining"
        - "X-RateLimit-Reset"
      allow_credentials: true
      max_age: 86400

    global_headers:
      X-Gateway: "Tyk"
      X-API-Version: "v1"
      X-Environment: "production"

    global_headers_remove:
      - "X-Internal-Token"
      - "X-Debug-Mode"

    global_response_headers:
      X-Powered-By: "Tyk Gateway"
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "DENY"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains"

    global_response_headers_remove:
      - "Server"
      - "X-AspNet-Version"

    enable_ip_whitelisting: true
    allowed_ips:
      - "10.0.0.0/8"
      - "172.16.0.0/12"
      - "192.168.1.100"

    global_size_limit: 10485760

    do_not_track: false
    enable_detailed_recording: true

    extended_paths:
      url_rewrites:
        - path: "/search"
          method: "GET"
          match_pattern: "/search/(.*)"
          rewrite_to: "/products/search?q=$1"
        - path: "/category/(.*)"
          method: "GET"
          match_pattern: "/category/(.*)"
          rewrite_to: "/products/filter?category=$1"

      transform_headers:
        - path: ".*"
          method: "GET"
          delete_headers:
            - "X-Internal-Header"
          add_headers:
            X-API-Version: "v1"
            X-Response-Time: "$tyk_context.response_time"

      ignored:
        - path: "/health"
          method_actions:
            GET:
              action: "no_action"
              code: 200
        - path: "/version"
          method_actions:
            GET:
              action: "no_action"
              code: 200

      size_limits:
        - path: "/upload"
          method: "POST"
          size_limit: 52428800

      method_transforms:
        - path: "/legacy"
          method: "GET"
          to_method: "POST"

    custom_middleware:
      pre:
        - name: "RateLimitAndQuotaCheck"
      post:
        - name: "ResponseTransformJSONMiddleware"

    version_data:
      not_versioned: true
      versions:
        Default:
          name: "v1"